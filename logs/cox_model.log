-----------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sotrovimab-
> Paxlovid-Molnupiravir/logs/cox_model.log
  log type:  text
 opened on:  30 Oct 2023, 11:34:31

. 
. *Set Ado file path
. adopath + "$projectdir/analysis/ado"
  [1]  (BASE)      "C:\Program Files\Stata17\ado\base/"
  [2]  (SITE)      "C:\Program Files\Stata17\ado\site/"
  [3]              "."
  [4]  (PERSONAL)  "C:\users\PUBLIC\documents/"
  [5]  (PLUS)      "C:\users\PUBLIC\documents/"
  [6]  (OLDPLACE)  "c:\ado/"
  [7]              "C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sotr
> ovimab-Paxlovid-Molnupiravir/analysis/ado"

. 
. * SET Index date 
. global indexdate                        = "01/03/2020"

. 
. 
. use "$projectdir/output/data/main.dta", clear

. 
. 
. * Models
. global crude    i.drug 

. global agesex   i.drug age i.sex

. global adj              i.drug age i.sex i.region_nhs i.imdq5 White 1b.bmi_group ///
>                                 paxlovid_contraindicated i.vaccination_status diabetes chronic_cardiac_disease chronic_resp
> iratory_disease hypertension ///
>                             downs_syndrome solid_cancer haem_disease renal_disease liver_disease imid_on_drug immunosuppres
> sion hiv_aids organ_transplant rare_neuro  

. global adj2     i.drug age i.sex i.region_nhs i.imdq5 White 1b.bmi_group 

. global adj3     i.drug age i.sex i.region_nhs i.imdq5 White 1b.bmi_group ///
>                                 paxlovid_contraindicated i.vaccination_status diabetes chronic_cardiac_disease chronic_resp
> iratory_disease hypertension 

. global adj4     i.drug age i.sex i.region_nhs i.imdq5 White 1b.bmi_group ///
>                                 paxlovid_contraindicated i.vaccination_status diabetes chronic_cardiac_disease chronic_resp
> iratory_disease hypertension ///
>                             downs_syndrome solid_cancer haem_disease renal_disease liver_disease imid_on_drug immunosuppres
> sion hiv_aids organ_transplant rare_neuro ///
>                                 dementia care_home serious_mental_illness

. 
. * Outcome
. global ae_disease                       ae_diverticulitis                               ///
>                                                         ae_diarrhoea                                    ///
>                                                         ae_taste                                                ///
>                                                         ae_rash                                                 ///
>                                                         ae_bronchospasm                                 ///
>                                                         ae_contactderm                                  ///
>                                                         ae_dizziness                                    ///
>                                                         ae_nausea_vomit                                 ///
>                                                         ae_headache                                             ///
>                                                         ae_anaphylaxis                                  ///
>                                                         ae_drugreaction                                 ///
>                                                         ae_ra                                                   ///
>                                                         ae_sle                                                  ///
>                                                         ae_psorasis                                     ///
>                                                         ae_psa                                                  ///
>                                                         ae_axspa                                                ///
>                                                         ae_ibd                                          

. global ae_disease_serious       ae_diverticulitis_serious               ///
>                                                         ae_diarrhoea_serious                    ///
>                                                         ae_taste_serious                                ///
>                                                         ae_rash_serious                                 ///
>                                                         ae_contactderm_serious                  ///
>                                                         ae_dizziness_serious                    ///
>                                                         ae_nausea_vomit_serious                 ///
>                                                         ae_headache_serious                             ///
>                                                         ae_anaphylaxis_serious                  ///
>                                                         ae_drugreaction_serious                 ///
>                                                         ae_ra_serious                                   ///
>                                                         ae_sle_serious                                  ///
>                                                         ae_psorasis_serious                     ///
>                                                         ae_psa_serious                                  ///
>                                                         ae_axspa_serious                                ///
>                                                         ae_ibd_serious                                          

. global ae_combined                      ae_all                                                  ///
>                                                         ae_all_serious                                  ///
>                                                         ae_spc_all                                              ///
>                                                         ae_spc_serious                                  ///
>                                                         ae_drug_all                                             ///
>                                                         ae_drug_serious                                 ///
>                                                         ae_imae_all                                             ///     
>                                                         ae_imae_serious 

. 
. *******************************************************************************************************************
. ** Main analysis 1 ** 
. tab drug covid_test

                      | covid_test
                 drug |         1 |     Total
----------------------+-----------+----------
              control |    26,381 |    26,381 
           sotrovimab |        84 |        84 
             paxlovid |        80 |        80 
         molnupiravir |       104 |       104 
----------------------+-----------+----------
                Total |    26,649 |    26,649 

. tab eligible

   eligible |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     26,649      100.00      100.00
------------+-----------------------------------
      Total |     26,649      100.00

. tab drug pre_drug_test

                      |     pre_drug_test
                 drug |  <=3 days   4-5 days |     Total
----------------------+----------------------+----------
           sotrovimab |        56         28 |        84 
             paxlovid |        44         36 |        80 
         molnupiravir |        68         36 |       104 
----------------------+----------------------+----------
                Total |       168        100 |       268 

. tab drug paxlovid_contraindicated

                      | paxlovid_contraindica
                      |          ted
                 drug |         0          1 |     Total
----------------------+----------------------+----------
              control |    12,185     14,196 |    26,381 
           sotrovimab |        29         55 |        84 
             paxlovid |        43         37 |        80 
         molnupiravir |        57         47 |       104 
----------------------+----------------------+----------
                Total |    12,314     14,335 |    26,649 

. 
. *** Graphs - Schoenfeld Residual & log-log plot
. foreach fail in $ae_combined {
  2.         stset stop_`fail', id(patient_id) origin(time start_date) enter(time start_date) failure(fail_`fail'==1) 
  3.                         stcox i.drug 
  4.                         estat phtest,de
  5.                         estat phtest, plot(1.drug) ytitle("Scaled Schoenfeld Residual, Sotrovimab", size(small)) name(sc
> hoenfeld_sot_`fail', replace)
  6.                         estat phtest, plot(2.drug) ytitle("Scaled Schoenfeld Residual, Paxlovid",size(small)) name(schoe
> nfeld_pax_`fail', replace)
  7.                         estat phtest, plot(3.drug) ytitle("Scaled Schoenfeld Residual, Molnupiravir",size(small)) name(s
> choenfeld_mol_`fail', replace)
  8.                         graph combine schoenfeld_sot_`fail' schoenfeld_pax_`fail' schoenfeld_mol_`fail', title("Schoenfe
> ld Residual `fail'") saving("$projectdir/output/figures/schoenfield_`fail'", replace)
  9.                         graph export "$projectdir/output/figures/schoenfield_`fail'.svg", as(svg) replace
 10.                         stphplot, by(drug) legend(order(1 "Control" 2 "Sotrovimab" 3 "Paxlovid" 4 "Molnupiravir") symxsi
> ze(*0.4) size(small)) title ("log-log plot `fail'") saving("$projectdir/output/figures/loglog_plot_`fail'", replace)    
 11.                         graph export "$projectdir/output/figures/loglog_plot_`fail'.svg", as(svg) replace
 12. }

Survival-time data settings

           ID variable: patient_id
         Failure event: fail_ae_all==1
Observed time interval: (stop_ae_all[_n-1], stop_ae_all]
     Enter on or after: time start_date
     Exit on or before: failure
     Time for analysis: (time-origin)
                Origin: time start_date

--------------------------------------------------------------------------
     26,649  total observations
         24  ignored because never entered
     25,130  observations end on or before enter()
--------------------------------------------------------------------------
      1,495  observations remaining, representing
      1,495  subjects
        919  failures in single-failure-per-subject data
  27,980.75  total analysis time at risk and under observation
                                                At risk from t =         0
                                     Earliest observed entry t =         0
                                          Last observed exit t =        29

         Failure _d: fail_ae_all==1
   Analysis time _t: (stop_ae_all-origin)
             Origin: time start_date
  Enter on or after: time start_date
        ID variable: patient_id

Iteration 0:   log likelihood = -6350.1214
Iteration 1:   log likelihood = -6347.0135
Iteration 2:   log likelihood = -6346.9721
Iteration 3:   log likelihood = -6346.9718
Iteration 4:   log likelihood = -6346.9718
Refining estimates:
Iteration 0:   log likelihood = -6346.9718

Cox regression with Breslow method for ties

No. of subjects =     1,495                             Number of obs =  1,495
No. of failures =       919
Time at risk    = 27,980.75
                                                        LR chi2(3)    =   6.30
Log likelihood = -6346.9718                             Prob > chi2   = 0.0979

-------------------------------------------------------------------------------
           _t | Haz. ratio   Std. err.      z    P>|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
         drug |
  sotrovimab  |   1.020251   .5900271     0.03   0.972     .3284312    3.169349
    paxlovid  |    3.57698   1.795294     2.54   0.011     1.337508    9.566135
molnupiravir  |   2.504438   1.449592     1.59   0.113     .8054283    7.787419
-------------------------------------------------------------------------------

Test of proportional-hazards assumption

Time function: Analysis time
--------------------------------------------------------
             |        rho     chi2       df    Prob>chi2
-------------+------------------------------------------
     0b.drug |          .        .        1           .
      1.drug |   -0.01416     0.18        1       0.6678
      2.drug |    0.02002     0.37        1       0.5438
      3.drug |    0.03237     0.96        1       0.3267
-------------+------------------------------------------
 Global test |                1.51        3       0.6793
--------------------------------------------------------
file C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sotrovimab-Paxlovid
> -Molnupiravir/output/figures/schoenfield_ae_all.gph saved
file C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and
    antivirals\Safety-Sotrovimab-Paxlovid-Molnupiravir/output/figures/schoenfield_ae_all.svg saved as SVG format

         Failure _d: fail_ae_all==1
   Analysis time _t: (stop_ae_all-origin)
             Origin: time start_date
  Enter on or after: time start_date
        ID variable: patient_id
--Break--
r(1);

end of do-file

--Break--
r(1);

. tab elig

   eligible |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     26,649      100.00      100.00
------------+-----------------------------------
      Total |     26,649      100.00

. tab pre_drug_test

                   pre_drug_test |      Freq.     Percent        Cum.
---------------------------------+-----------------------------------
                        <=3 days |        168       62.69       62.69
                        4-5 days |        100       37.31      100.00
---------------------------------+-----------------------------------
                           Total |        268      100.00

. tab pre_drug_test_time

pre_drug_te |
    st_time |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |         37       13.81       13.81
          1 |         37       13.81       27.61
          2 |         56       20.90       48.51
          3 |         38       14.18       62.69
          4 |         48       17.91       80.60
          5 |         52       19.40      100.00
------------+-----------------------------------
      Total |        268      100.00

. do "C:\Users\k1635179\AppData\Local\Temp\STDf70_000000.tmp"

. ********************************************************************************
. *
. *       Do-file:                        define covariates.do
. *       Project:                        Sotrovimab-Paxlovid-Molnupiravir
. *   Date:                               15/2/23
. *       Programmed by:          Katie Bechman
. *       Description:            data management, reformat variables, categorise variables, label variables 
. *       Data used:                      data in memory (from output/input.csv) 
. *       Data created:           analysis main.dta  (main analysis dataset)
. *       Other output:           logfiles, printed to folder $Logdir
. *       User installed ado: (place .ado file(s) in analysis folder)
. 
. ****************************************************************************************************************
. **Set filepaths
. global projectdir "C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sot
> rovimab-Paxlovid-Molnupiravir"

. // global projectdir `c(pwd)'
. 
. di "$projectdir"
C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sotrovimab-Paxlovid-Moln
> upiravir

. capture mkdir "$projectdir/output/data"

. capture mkdir "$projectdir/output/figures"

. capture mkdir "$projectdir/output/tables"

. global logdir "$projectdir/logs"

. di "$logdir"
C:\Users\k1635179\OneDrive - King's College London\Katie\OpenSafely\Safety mAB and antivirals\Safety-Sotrovimab-Paxlovid-Moln
> upiravir/logs

. 
. * Open a log file
. cap log close
